<?php
echo "=== Laravel Storage Copy Solution ===\n\n";

// Path konfigurasi
$source = '/home/bant3812/laravel/storage/app/public';
$destination = '/home/bant3812/public_html/storage';

function copyDirectory($src, $dst) {
    $copied = 0;
    $skipped = 0;
    
    if (!is_dir($src)) {
        return false;
    }
    
    // Buat direktori tujuan jika belum ada
    if (!is_dir($dst)) {
        mkdir($dst, 0755, true);
        echo "âœ… Created directory: $dst\n";
    }
    
    $dir = opendir($src);
    
    while (false !== ($file = readdir($dir))) {
        if ($file == '.' || $file == '..') {
            continue;
        }
        
        $srcFile = $src . '/' . $file;
        $dstFile = $dst . '/' . $file;
        
        if (is_dir($srcFile)) {
            echo "ğŸ“ Processing directory: $file\n";
            $result = copyDirectory($srcFile, $dstFile);
            if ($result) {
                $copied += $result['copied'];
                $skipped += $result['skipped'];
            }
        } else {
            // Cek apakah file sudah ada dan sama
            if (file_exists($dstFile)) {
                $srcHash = md5_file($srcFile);
                $dstHash = md5_file($dstFile);
                
                if ($srcHash === $dstHash) {
                    echo "â­ï¸  Skipped (same): $file\n";
                    $skipped++;
                    continue;
                }
            }
            
            if (copy($srcFile, $dstFile)) {
                echo "âœ… Copied: $file\n";
                $copied++;
            } else {
                echo "âŒ Failed to copy: $file\n";
            }
        }
    }
    
    closedir($dir);
    return ['copied' => $copied, 'skipped' => $skipped];
}

function syncDirectory($src, $dst) {
    echo "ğŸ”„ Syncing files from storage to public...\n\n";
    
    if (!is_dir($src)) {
        echo "âŒ Source directory not found: $src\n";
        return false;
    }
    
    $result = copyDirectory($src, $dst);
    
    if ($result) {
        echo "\nâœ… Sync completed!\n";
        echo "ğŸ“Š Files copied: {$result['copied']}\n";
        echo "ğŸ“Š Files skipped: {$result['skipped']}\n";
        
        // Buat file marker untuk menandai ini adalah copy, bukan symlink
        file_put_contents($dst . '/.laravel-storage-copy', date('Y-m-d H:i:s'));
        echo "ğŸ“ Created marker file: .laravel-storage-copy\n";
        
        return true;
    }
    
    return false;
}

function createSyncScript($src, $dst) {
    $syncScript = '<?php
// Laravel Storage Sync Script
// Run this script whenever you upload new files to storage

$source = "' . $src . '";
$destination = "' . $dst . '";

' . file_get_contents(__FILE__) . '
';
    
    file_put_contents('sync-storage.php', $syncScript);
    echo "ğŸ“„ Created sync-storage.php for future updates\n";
}

try {
    echo "Source: $source\n";
    echo "Destination: $destination\n\n";
    
    // Cek source directory
    if (!is_dir($source)) {
        throw new Exception("Source directory tidak ditemukan: $source");
    }
    
    // List files yang akan di-copy
    echo "ğŸ“‹ Files in source directory:\n";
    $files = scandir($source);
    foreach ($files as $file) {
        if ($file != '.' && $file != '..') {
            $path = $source . '/' . $file;
            $type = is_dir($path) ? 'DIR' : 'FILE';
            $size = is_file($path) ? ' (' . round(filesize($path)/1024, 2) . ' KB)' : '';
            echo "   - $file [$type]$size\n";
        }
    }
    echo "\n";
    
    // Mulai sync
    if (syncDirectory($source, $destination)) {
        
        // Buat script sync untuk update selanjutnya
        createSyncScript($source, $destination);
        
        echo "\nğŸ‰ SUCCESS! Storage files berhasil di-copy ke public_html/storage\n";
        echo "\nğŸ“ CATATAN PENTING:\n";
        echo "- Karena symlink tidak tersedia, files di-copy langsung\n";
        echo "- Setiap kali upload file baru ke Laravel storage, jalankan sync-storage.php\n";
        echo "- Atau setup cron job untuk auto-sync\n";
        
        echo "\nğŸ”— URLs yang bisa diakses:\n";
        echo "- http://yourdomain.com/storage/images/file.jpg\n";
        echo "- http://yourdomain.com/storage/ambulan.zip\n";
        
        // Test akses file
        echo "\nğŸ§ª TESTING ACCESS:\n";
        $testFiles = ['images', 'ambulan.zip'];
        foreach ($testFiles as $file) {
            $fullPath = $destination . '/' . $file;
            if (file_exists($fullPath)) {
                $type = is_dir($fullPath) ? 'directory' : 'file';
                echo "âœ… $file ($type) - accessible\n";
            }
        }
        
    } else {
        throw new Exception("Gagal melakukan sync directory");
    }
    
} catch (Exception $e) {
    echo "âŒ ERROR: " . $e->getMessage() . "\n";
}

echo "\n" . str_repeat("=", 50) . "\n";
echo "Script selesai. Anda bisa mengganti index.php dengan file Laravel asli sekarang.\n";
?>